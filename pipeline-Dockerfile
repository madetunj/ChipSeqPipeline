#################################################################
# Dockerfile
#
# Software:         ABC 
# Software Version: 1.0.0
# Description:      Abraham ChIPSeq pipeline image
# Website:          https://github.com/stjude/seaseq
# Provides:         SEASEQ CWL pipeline
# Base Image:       madetunj/rose:v1.2.0
# Build Cmd:        docker build --rm -t madetunj/abc:v1.0.0 -f pipeline-Dockerfile .
# Pull Cmd:         docker pull madetunj/abc:v1.0.0
# Run Cmd:          docker run --rm -ti madetunj/abc:v1.0.0 
#################################################################

##  DEPENDENCIES from madetunj/rose:v1.2.0
#   bedtools
#   samtools
#   R
#   spp
#   rose: v1.2.0

##  ADDITIONAL dependencies from other docker images
#   WIGTOBIGWIG     madetunj/wigtobigwig:v4
#   BOWTIE          madetunj/bowtie:v1.2.3
#   BEDOPS          madetunj/bedops:v2.4.37
#   FASTQC          madetunj/fastqc:v0.11.9
#   MACS14          madetunj/macs:v1.4.2
#   SICER           madetunj/sicer:v1.0.2
#   BAM2GFF         madetunj/bam2gff:v1.1.0
#   IGVTOOLS        madetunj/igvtools:v2.8.2
#   MEMESUITE       madetunj/memesuite:v5.1.1


## LOADING DOCKERFILES
FROM madetunj/wigtobigwig:v4 as fromwig
FROM madetunj/bowtie:v1.2.3 as frombowtie
FROM madetunj/bedops:v2.4.37 as frombedops
FROM madetunj/madetunj/macs:v1.4.2 as frommacs
FROM madetunj/fastqc:v0.11.9 as fromfastqc
FROM madetunj/sicer:v1.0.2 as fromsicer
FROM madetunj/bam2gff:v1.1.0 as frombam2gff
FROM madetunj/igvtools:v2.8.2 as fromigv
FROM madetunj/memesuite:v5.1.1 as frommeme

## TOOLS to be built.
#   MEMESUITE
#   MACS
#   SICER

## BASE IMAGE
FROM madetunj/rose:v1.2.0
MAINTAINER Modupeore Adetunji "modupeore.adetunji@stjude.org"
WORKDIR /tmp

##  VERSION NAMES
ENV MACS_VERSION 1.4.2
ENV MEME_VERSION 5.1.1
ENV BEDOPS_VERSION 2.4.37
ENV IGV_VERSION 2.8.2
ENV SICER_VERSION 1.0.2
ENV B2G_VERSION 1.1.0

##  INSTALL MACS14
COPY --from=frommacs /opt/MACS-${MACS_VERSION} /opt/MACS-${MACS_VERSION}
RUN cd /opt/MACS-${MACS_VERSION}; \
    python2.7 setup.py install

##  INSTALL FASTQC
COPY --from=fromfastqc /opt/FastQC /opt/FastQC   
RUN ln -s /opt/FastQC/fastqc /usr/local/bin/

##  INSTALL MEMESUITE
ENV MEME_DIR /opt/meme
COPY --from=frommeme ${MEME_DIR} ${MEME_DIR}
COPY --from=frommeme /opt/meme-${MEME_VERSION} /opt/meme-${MEME_VERSION}
ENV PATH ${MEME_DIR}/bin:${MEME_DIR}/libexec/meme-${MEME_VERSION}:$PATH

# INSTALL required packages
RUN apt-get update && \
    apt-get install -y wget build-essential zlib1g-dev libexpat-dev libxml2-dev mpich ghostscript imagemagick && \
    cpan File::Which && \
    cpan HTML::PullParser && \
    cpan HTML::Template && \
    cpan HTML::TreeBuilder && \
    cpan JSON && \
    cpan XML::Simple && \
    cpan XML::Parser::Expat && \
    cpan Math::CDF && \
    cpan XML::Compile::SOAP11 && \
    cpan XML::Compile::WSDL11 && \
    cpan XML::Compile::Transport::SOAPHTTP

#  INSTALL MEME Suite
RUN cd /opt/meme-${MEME_VERSION} && \
    ./configure --prefix=${MEME_DIR} --with-url=http://meme-suite.org/ --enable-build-libxml2 --enable-build-libxslt && \
    make && \
    make install && \
    cd .. && \
    rm -rf meme-${MEME_VERSION}

# CLEANING TMP FILES
RUN apt-get clean && \
    apt-get purge && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* /usr/share/doc/* && \
    strip /usr/local/bin/*; true

##  INSTALL BAM2GFF
ENV B2G_NAME BAM2GFF
COPY --from=frombam2gff /opt/${B2G_NAME}-${B2G_VERSION} /opt/${B2G_NAME}-${B2G_VERSION}
ENV PATH /opt/${B2G_NAME}-${B2G_VERSION}/bin:${PATH}
ENV PYTHONPATH /opt/${B2G_NAME}-${B2G_VERSION}/lib:${PYTHONPATH}

##  INSTALL SICER
ENV SICER_NAME SICER2
COPY --from=fromsicer /opt/${SICER_NAME}-${SICER_VERSION} /opt/${SICER_NAME}-${SICER_VERSION}
RUN cd /opt/${SICER_NAME}-${SICER_VERSION} && \
    python setup.py install

##  INSTALL WIGTOBIGWIG
COPY --from=fromwig /usr/local/bin/wigToBigWig /usr/local/bin/wigToBigWig

##  INSTALL BOWTIE
COPY --from=frombowtie /usr/local/bin/bowtie /usr/local/bin/bowtie
COPY --from=frombowtie /usr/local/bin/bowtie-align-l /usr/local/bin/bowtie-align-l
COPY --from=frombowtie /usr/local/bin/bowtie-align-s /usr/local/bin/bowtie-align-s
COPY --from=frombowtie /usr/local/bin/bowtie-build /usr/local/bin/bowtie-build
COPY --from=frombowtie /usr/local/bin/bowtie-build-l /usr/local/bin/bowtie-build-l
COPY --from=frombowtie /usr/local/bin/bowtie-build-s /usr/local/bin/bowtie-build-s
COPY --from=frombowtie /usr/local/bin/bowtie-inspect /usr/local/bin/bowtie-inspect
COPY --from=frombowtie /usr/local/bin/bowtie-inspect-l /usr/local/bin/bowtie-inspect-l
COPY --from=frombowtie /usr/local/bin/bowtie-inspect-s /usr/local/bin/bowtie-inspect-s

##  INSTALL BEDOPS
ENV BEDOPS_NAME bedops
COPY --from=frombedops /opt/${BEDOPS_NAME}-${BEDOPS_VERSION}/bin /usr/local/bin

##  INSTALL IGV
COPY --from=fromigv /opt/IGV_${IGV_VERSION} /opt/IGV_${IGV_VERSION}
ENV PATH /opt/IGV_${IGV_VERSION}:${PATH}